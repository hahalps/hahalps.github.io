<!DOCTYPE html>





<html lang="">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 3.8.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.4.0">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.4.0">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.4.0">
  <link rel="mask-icon" href="/images/logo.svg?v=7.4.0" color="#222">

<link rel="stylesheet" href="/css/main.css?v=7.4.0">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.7.0">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '7.4.0',
    exturl: false,
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false},
    copycode: {"enable":false,"show_result":false,"style":null},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: '',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    translation: {
      copy_button: 'Kopieren',
      copy_success: 'Kopiert',
      copy_failure: 'Kopieren fehlgeschlagen'
    },
    sidebarPadding: 40
  };
</script>

  <meta name="description" content="bt协议的话，就是一种不仅支持从服务器下载东西，还支持从其他的下载者下载他们已经下载好但是自己没有下载好的协议，主要目的增加每个下载者的下载速度，提高网络带宽的利用率。">
<meta name="keywords" content="好奇 憨 热爱学习">
<meta property="og:type" content="article">
<meta property="og:title" content="前置知识">
<meta property="og:url" content="http://yoursite.com/2019/07/18/前置知识/index.html">
<meta property="og:site_name" content="MrLi的博客">
<meta property="og:description" content="bt协议的话，就是一种不仅支持从服务器下载东西，还支持从其他的下载者下载他们已经下载好但是自己没有下载好的协议，主要目的增加每个下载者的下载速度，提高网络带宽的利用率。">
<meta property="og:locale" content="default">
<meta property="og:updated_time" content="2019-07-18T11:42:23.741Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="前置知识">
<meta name="twitter:description" content="bt协议的话，就是一种不仅支持从服务器下载东西，还支持从其他的下载者下载他们已经下载好但是自己没有下载好的协议，主要目的增加每个下载者的下载速度，提高网络带宽的利用率。">
  <link rel="canonical" href="http://yoursite.com/2019/07/18/前置知识/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true,
    isPage: false,
    isArchive: false
  };
</script>

  <title>前置知识 | MrLi的博客</title>
  








  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="default">
  <div class="container use-motion">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">MrLi的博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <p class="site-subtitle">喜欢放空,热爱生活     喜欢挖坑，慢慢填</p>
      
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Navigationsleiste an/ausschalten">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
      
      
      
        
        <li class="menu-item menu-item-home">
      
    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>Startseite</a>

  </li>
      
      
      
        
        <li class="menu-item menu-item-archives">
      
    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>Archiv</a>

  </li>
  </ul>

    

</nav>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
      <article itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block post">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/07/18/前置知识/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mr Li">
      <meta itemprop="description" content="想成为厨子的程序猿">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MrLi的博客">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">前置知识

          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Veröffentlicht am</span>

              
                
              

              <time title="Erstellt: 2019-07-18 19:10:16 / Geändert am: 19:42:23" itemprop="dateCreated datePublished" datetime="2019-07-18T19:10:16+08:00">2019-07-18</time>
            </span>
          
            

            
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>bt协议的话，就是一种不仅支持从服务器下载东西，还支持从其他的下载者下载他们已经下载好但是自己没有下载好的协议，主要目的<strong>增加每个下载者的下载速度，提高网络带宽的利用率</strong>。</p>
<a id="more"></a>
<p><strong>下面的话记录的是我作为一名“DJ”对bt的解读</strong></p>
<p>（类似与预习，记录可能不太准确）</p>
<p>BT程序的实现涉及到多个模块的实现，下面的一一列举：</p>
<p>1，种子解析模块。主要实现的功能解析从tracker传来的种子文件，其中里面我认为比较重要的信息：待下载文件的大小，各个分段的哈希值，tracker服务器的URL等等</p>
<p>2，位图管理模块，主要是实现的功能是管理自己下载的信息，以及判断自己还有那些信息待下载。</p>
<p>3，出错信息模块，程序遇到非法输入或者出现运行型错误的处理。</p>
<p>4，运行日志模块，顾名思义，不太多介绍的了hh(其实不知怎么写)</p>
<p>5，信号处理模块，对于一些常出现的中断信号设置处理函数。</p>
<p>6，peer管理模块，peer就是其他下载端，因为bt程序支持从peer下载没下载的数据，所以的话分出这个模块来记录其他peer的信息，主要的信息有ip, port以及位图信息等等。</p>
<p>7，消息处理模块的话，其实处理的是peer和peer之间的通信，比如当自己已经下载有信息的某一个部分，我们需要发信息给其他的peer，告诉他们我已经有了这一部分的数据，你们可以从我这里下载，而其他的peer处理这个信息之后就向这个peer发送数据请求了，这里涉及到的有have信息以及request信息，当然的话还有其他的啦。</p>
<p>8,缓冲管理模块，主要的目的减少对硬盘的读写次数，提高硬盘的寿命，此外的话，从内存读的速度大于直接从硬盘读取的速度。</p>
<p>9，策略管理模块，有点（联想）类似于tcp协议的拥塞控制，都是用来提高网络的整体性能的。有一个影响比较深，就是提供给那些能给自己更快下载的peer更高的下载速度（有点绕），就是你能提高给我东西，我也提供东西给你，属于一种互利共赢的关系，同时保留一个非阻塞优化peer，用来更新现有的“答案”。</p>
<p>10，连接tracket模块，这个没看过，猜想一下，是不是用来连接tracker服务器，获取种子文件，并且通过tracket告知其他peer, 现在我们是同一阵营的，我们之间需要互相扶持啊。</p>
<p>11，与peer交换数据模块，应该是同tcp来互通有无吧。</p>
<p>12.主函数的实现，就是以一个什么样的方式去调用上面我们提到的模块。</p>
<hr>
<p><strong>进化为吐槽家</strong></p>
<p>理解bt协议文件分发系统的几个实体构成：（我呢，自己串联一下）</p>
<p>下载东西的时候需要一个下载源吧，所以的话需要一个web服务器和原始文件提供者吧，而谁去下载这些东西呢？就是一个或者多个下载者，下载者不可能凭空连接服务器吧，需要借助工具去下载吧，这里的工具就是网络浏览器，因为下载者不仅可以从web服务器那里下载文件，他还可以从其他的下载者去下载别人下载好的数据，而他怎么知道谁还跟他下载同样的文件呢？这就需要到了tracket服务器和种子文件啦。</p>
<hr>
<p><strong>bt协议大概的工作流程</strong></p>
<p>首先的下载者从web服务器获得种子文件，解析种子文件获得tracket服务器的地址，通过tracket服务器知道其他的下载者的Ip地址和端口号，接着连接peer们进行数据间的交互。这里提一下的是传送的数据量规定为多少呢？逻辑上把共享文件划分成一个个piece，每个piece的大小为256Kb, 而实际上传送的是以slice为单位的，每个slice的大小为16Kb,每16个slice构成一个piece。对了，每一个piece都有其对应的哈希值，大小为20字节，主要防止传送的数据被篡改。这些数据是存放在种子文件里的。</p>
<hr>
<p><strong>通信编码</strong></p>
<p>通信编码，就是你给我的信息的是以一种什么样的格式发给我的，开头是什么意思，中间的是什么意思，结尾的部分又是什么样的意思，你给我解释清楚，这里的话采用的是B编码。</p>
<p>B编码的话有四种数据类型，字符串，整型，列表以及字典（map映射）。下面的话简单写一下这四种的类型长什么样吧！</p>
<p><strong>字符串</strong>：（长度）：（内容）  ex:   2:li</p>
<p><strong>整型</strong>：i(内容)e    ex： i40e  代表的意思就是40, 还有一点需要注意的是内容里面数值的进制是十进制的。</p>
<p><strong>list(列表)</strong> ：l(合法内容)e   ex:2:li2:pse 代表的含义是两个字符串，分别为li &amp;  ps。</p>
<p><strong>map(字典)</strong>： d(1个或者多个键值对)e   (不举了)hhh</p>
<hr>
<p><strong>种子的文件结构</strong></p>
<p>了解种子的文件结构是我们后面写解析模块需要了解的。我们需要知道的比较关键的东西有：tracket服务器的地址，每个piece的长度（前面不是说过是256kb吗？为什么还需要去获取piece的长度呢？这是因为piece的长度根据实现的不同，是有变化的，通常有128kb, 256kb, 512kb, 我在像的一件事是现在已经到了5G时代，每个piece的划分会不会变得更大呢？），piece的哈希值，文件名，文件的长度（这里说一句，如果文件的长度模piece的长度有剩余的话，按作一个piece看待就行了）。以上提到所需要的信息都有其对应的关键字，分别为announce(announce-list), piece length, pieces,   name, length。</p>
<p>其实的话，上面提到的东西都是存储成一个字典的形式的，对应的是字典当中的键。</p>
<p><strong>说一些多文件以及单文件之间的区别</strong></p>
<p>多文件相比于单文件的话多了一个关键词files, 可以通过files来判断这个文件是单文件还是多文件，对于单文件来说的说的话，他只有一个关于长度的字典，而多文件的话是一个列表，里面存在多个关于长度的字典。此外的话，多文件还多一个path关键词，是用来存放共享文件的路径的。</p>
<p>还有想说明一下的是，上面的讲解其实是忽略了一些关键词的，比如说种子文件的创建日期，种子的作者等等我们在进行通信不需要的信息，所以就不一一解析了。</p>
<hr>
<p><strong>与tracker的交互</strong></p>
<p>这些get请求的参数以及返回的参数我就不细看了，用的时候再说，注重注意一下get参数当中的info_hash, peer_id, 以及返回信息当中的关键字peers就行了。</p>
<hr>
<p><strong>peer之间的通信协议</strong></p>
<p>这里的话，为了建立起每两个peer间的通信，需要维护一些状态和规定双方传送信息的格式。</p>
<p>状态的话有四种，你对我阻塞，我对你阻塞，你对我感兴趣，我对你感兴趣，通过这四种状态来判断我当前需要发送什么样的信息。（当我对你感兴趣且你没有对我阻塞的话，我就可以从你那里下载数据，如果当我没对你阻塞且你对我感兴趣的话，你可以从我这下载数据）。</p>
<p>消息的话有以下几种：握手消息，用来建立两个peer之间的连接；keep_alive消息，（我还活着，不要断了我们之间的联系）是跟后面提到的策略有关，就是当我们发现跟某个peer之间过了某个规定的时间还是没有进行任何的数据交换的，就断开跟这个peer的连接；chock消息，就是发送一个消息给某个peer,说，哎，暂时吧，emmm,   你不能来我这边下载数据了；unchock消息，跟chock消息是相反的；interested消息，当发现别人有个数据且自己没有的时候，给有的发送这个消息；not interested消息，跟interested是相反，意思是：对不起啊，我对你不感兴趣，你放过我吧！；have消息，当自己下载完一个完整的piece之后，向跟自己有连接的peer发送这个消息，提示他们如果没有的话可以来这里下载。bitfield消息：就是在交换完握手消息之后交换一下各自的位图信息，通过位图来判断是否对对方感兴趣；request消息，当发现自己对某个peer感兴趣且peer没有讲自己阻塞的情况下，向这个peer发送请求信息；piece信息：就是接收到request信息之后，通过piece消息发送对方感兴趣的数据；后面两个信息就不讲了，一个是cancel消息，意思是告诉对方“老子”不需要了，port消息的话是运用在DHT当中的。</p>
<hr>
<p><strong>关键算法和策略</strong></p>
<p>接下来的话就是简单用自己的话阐述三个书中介绍的策略。</p>
<p>第一个的话是<strong>流水线工作</strong>，想象成一条传送带，来了多少个request, 我就依次地处理每一个请求，这个提高效率的原因是不是以前的话是一个一个处理的，而是捆绑处理的呢？</p>
<p>第二个的话片段选择法，（里面提到的有关在某个时间点下载速度增加的事实自己在下载的时候有体会到），分为四个小的策略，第一个的话是如果你向某个peer请求某个piece的slice，关于这个piece剩余的slice也向这个peer请求，不用去查看其他的peer是否拥有剩余的slice的操作，第二个的话，优先下载拥有率比较低的piece,这样做的原因是防止拥有这个piece的peer在下载完成之后离开，第二个的话下载了这个piece的peer,其他没有下载的peer可以像这个发送request小心请求，加快整体的下载速度；第三个的话，刚开始的话，随机下载一个piece，而不采取第二个的做法，因为你采取第二做法的话，由于拥有率较低，你很能下载到这个piece, 而一旦下载完这个随机piece后，其他的没有的peer会接触对你的阻塞，让你在一开始的时候获得较高的下载速度；最后一个是最后阶段模式，当你下载到了99%之后，（感性说法，具体的是差不多下载完成），你可以先所有的peer发送slice请求，一旦结束之后，向那些没来的及发的发送cancel消息就行了。</p>
<p>最后一个的话是阻塞算法，具体的做法跟4个peer保持联系，把其他的peer的联系状态设置为阻塞，同时保持一个优化阻塞peer，这个的目的是为了发现是否存在更好的下载速度peer,来替代4个当中的一个。（10s 30s是最佳实践结果，当然啦根据网络状态的不同可以改变这个数值）</p>
<p>同时下载完成的peer不可以一下载玩就离开网络，就像肥皂剧当中“用完就扔”的行为，需要在这个网络待一段时间，为能从较快下载的peer提供服务。</p>
<hr>
<p><strong>Good Ending!!!!</strong></p>

    </div>

    
    
    
        
      

      <footer class="post-footer">

        

          <div class="post-nav">
            <div class="post-nav-next post-nav-item">
              
                <a href="/2019/07/18/区间合并/" rel="next" title="区间合并">
                  <i class="fa fa-chevron-left"></i> 区间合并
                </a>
              
            </div>

            <span class="post-nav-divider"></span>

            <div class="post-nav-prev post-nav-item">
              
                <a href="/2019/07/18/bt解析一/" rel="prev" title="bt解析一">
                  bt解析一 <i class="fa fa-chevron-right"></i>
                </a>
              
            </div>
          </div>
        
      </footer>
    
  </div>
  
  
  
  </article>

  </div>


          </div>
          

        </div>
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">
        
        
        
        
      

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Inhaltsverzeichnis
        </li>
        <li class="sidebar-nav-overview">
          Übersicht
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Mr Li</p>
  <div class="site-description" itemprop="description">想成为厨子的程序猿</div>
</div>
  <nav class="site-state motion-element">
      <div class="site-state-item site-state-posts">
        
          <a href="/archives/">
        
          <span class="site-state-item-count">70</span>
          <span class="site-state-item-name">Artikel</span>
        </a>
      </div>
    
  </nav>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Mr Li</span>
</div>
  <div class="powered-by">Erstellt mit  <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> v3.8.0</div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">Design – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> v7.4.0</div>

        












        
      </div>
    </footer>
  </div>

  


  <script src="/lib/anime.min.js?v=3.1.0"></script>
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
<script src="/js/utils.js?v=7.4.0"></script><script src="/js/motion.js?v=7.4.0"></script>
<script src="/js/schemes/muse.js?v=7.4.0"></script>
<script src="/js/next-boot.js?v=7.4.0"></script>



  





















  

  

  

</body>
</html>
